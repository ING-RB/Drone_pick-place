function criticalVal = getChiSqCriticalValue(dof, significanceLevelIdx, scale)
%This function is for internal use only. It may be removed in the future.

%GETCHISQCRITICALVALUE Compute the critical value for Chi squared
%   distribution at the given degrees-of-freedom (DoFs) and significance level.
%   The values for the first 100 DoFs are taken from the link below
%   https://www.itl.nist.gov/div898/handbook/eda/section3/eda3674.htm
%   
%   For higher DoFs, the critical value is estimated through linear regression.

%   Copyright 2019-2020 The MathWorks, Inc.

%#codegen

if nargin < 3
    s = 1;
else
    s = scale;
end

persistent A polyCoeff
if isempty(polyCoeff)
    polyCoeff = nan(2, 5);
end

if isempty(A)
A = [
    % row number represents dof
    % each column is for a different (1 - significance) value
    %0.9     %0.95     %0.975     %0.99    %0.999   % (1 - alpha)    
    2.7060    3.8410    5.0240    6.6350   10.8280
    4.6050    5.9910    7.3780    9.2100   13.8160
    6.2510    7.8150    9.3480   11.3450   16.2660
    7.7790    9.4880   11.1430   13.2770   18.4670
    9.2360   11.0700   12.8330   15.0860   20.5150
   10.6450   12.5920   14.4490   16.8120   22.4580
   12.0170   14.0670   16.0130   18.4750   24.3220
   13.3620   15.5070   17.5350   20.0900   26.1250
   14.6840   16.9190   19.0230   21.6660   27.8770
   15.9870   18.3070   20.4830   23.2090   29.5880
   17.2750   19.6750   21.9200   24.7250   31.2640
   18.5490   21.0260   23.3370   26.2170   32.9100
   19.8120   22.3620   24.7360   27.6880   34.5280
   21.0640   23.6850   26.1190   29.1410   36.1230
   22.3070   24.9960   27.4880   30.5780   37.6970
   23.5420   26.2960   28.8450   32.0000   39.2520
   24.7690   27.5870   30.1910   33.4090   40.7900
   25.9890   28.8690   31.5260   34.8050   42.3120
   27.2040   30.1440   32.8520   36.1910   43.8200
   28.4120   31.4100   34.1700   37.5660   45.3150
   29.6150   32.6710   35.4790   38.9320   46.7970
   30.8130   33.9240   36.7810   40.2890   48.2680
   32.0070   35.1720   38.0760   41.6380   49.7280
   33.1960   36.4150   39.3640   42.9800   51.1790
   34.3820   37.6520   40.6460   44.3140   52.6200
   35.5630   38.8850   41.9230   45.6420   54.0520
   36.7410   40.1130   43.1950   46.9630   55.4760
   37.9160   41.3370   44.4610   48.2780   56.8920
   39.0870   42.5570   45.7220   49.5880   58.3010
   40.2560   43.7730   46.9790   50.8920   59.7030
   41.4220   44.9850   48.2320   52.1910   61.0980
   42.5850   46.1940   49.4800   53.4860   62.4870
   43.7450   47.4000   50.7250   54.7760   63.8700
   44.9030   48.6020   51.9660   56.0610   65.2470
   46.0590   49.8020   53.2030   57.3420   66.6190
   47.2120   50.9980   54.4370   58.6190   67.9850
   48.3630   52.1920   55.6680   59.8930   69.3470
   49.5130   53.3840   56.8960   61.1620   70.7030
   50.6600   54.5720   58.1200   62.4280   72.0550
   51.8050   55.7580   59.3420   63.6910   73.4020
   52.9490   56.9420   60.5610   64.9500   74.7450
   54.0900   58.1240   61.7770   66.2060   76.0840
   55.2300   59.3040   62.9900   67.4590   77.4190
   56.3690   60.4810   64.2010   68.7100   78.7500
   57.5050   61.6560   65.4100   69.9570   80.0770
   58.6410   62.8300   66.6170   71.2010   81.4000
   59.7740   64.0010   67.8210   72.4430   82.7200
   60.9070   65.1710   69.0230   73.6830   84.0370
   62.0380   66.3390   70.2220   74.9190   85.3510
   63.1670   67.5050   71.4200   76.1540   86.6610
   64.2950   68.6690   72.6160   77.3860   87.9680
   65.4220   69.8320   73.8100   78.6160   89.2720
   66.5480   70.9930   75.0020   79.8430   90.5730
   67.6730   72.1530   76.1920   81.0690   91.8720
   68.7960   73.3110   77.3800   82.2920   93.1680
   69.9190   74.4680   78.5670   83.5130   94.4610
   71.0400   75.6240   79.7520   84.7330   95.7510
   72.1600   76.7780   80.9360   85.9500   97.0390
   73.2790   77.9310   82.1170   87.1660   98.3240
   74.3970   79.0820   83.2980   88.3790   99.6070
   75.5140   80.2320   84.4760   89.5910  100.8880
   76.6300   81.3810   85.6540   90.8020  102.1660
   77.7450   82.5290   86.8300   92.0100  103.4420
   78.8600   83.6750   88.0040   93.2170  104.7160
   79.9730   84.8210   89.1770   94.4220  105.9880
   81.0850   85.9650   90.3490   95.6260  107.2580
   82.1970   87.1080   91.5190   96.8280  108.5260
   83.3080   88.2500   92.6890   98.0280  109.7910
   84.4180   89.3910   93.8560   99.2280  111.0550
   85.5270   90.5310   95.0230  100.4250  112.3170
   86.6350   91.6700   96.1890  101.6210  113.5770
   87.7430   92.8080   97.3530  102.8160  114.8350
   88.8500   93.9450   98.5160  104.0100  116.0920
   89.9560   95.0810   99.6780  105.2020  117.3460
   91.0610   96.2170  100.8390  106.3930  118.5990
   92.1660   97.3510  101.9990  107.5830  119.8500
   93.2700   98.4840  103.1580  108.7710  121.1000
   94.3740   99.6170  104.3160  109.9580  122.3480
   95.4760  100.7490  105.4730  111.1440  123.5940
   96.5780  101.8790  106.6290  112.3290  124.8390
   97.6800  103.0100  107.7830  113.5120  126.0830
   98.7800  104.1390  108.9370  114.6950  127.3240
   99.8800  105.2670  110.0900  115.8760  128.5650
  100.9800  106.3950  111.2420  117.0570  129.8040
  102.0790  107.5220  112.3930  118.2360  131.0410
  103.1770  108.6480  113.5440  119.4140  132.2770
  104.2750  109.7730  114.6930  120.5910  133.5120
  105.3720  110.8980  115.8410  121.7670  134.7460
  106.4690  112.0220  116.9890  122.9420  135.9780
  107.5650  113.1450  118.1360  124.1160  137.2080
  108.6610  114.2680  119.2820  125.2890  138.4380
  109.7560  115.3900  120.4270  126.4620  139.6660
  110.8500  116.5110  121.5710  127.6330  140.8930
  111.9440  117.6320  122.7150  128.8030  142.1190
  113.0380  118.7520  123.8580  129.9730  143.3440
  114.1310  119.8710  125.0000  131.1410  144.5670
  115.2230  120.9900  126.1410  132.3090  145.7890
  116.3150  122.1080  127.2820  133.4760  147.0100
  117.4070  123.2250  128.4220  134.6420  148.2300
  118.4980  124.3420  129.5610  135.8070  149.4490 ];
end

if (dof > 100) && isnan(polyCoeff(1, significanceLevelIdx))
    p = polyfit([60:100]', A(60:end,significanceLevelIdx), 1);
    polyCoeff(:, significanceLevelIdx) = [p(1), p(2)]';
end

if dof > 100
    criticalVal = dof*polyCoeff(1, significanceLevelIdx) + polyCoeff(2, significanceLevelIdx);
else
    criticalVal = A(dof, significanceLevelIdx);
end

% apply the scale
criticalVal = criticalVal * s;

end

