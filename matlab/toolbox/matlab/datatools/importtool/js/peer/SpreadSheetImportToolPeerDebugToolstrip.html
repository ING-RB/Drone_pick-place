<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="-1">
    <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Spreadsheet Import Tool Peer Showcase Page</title>
    <!-- Load css -->
    <link rel="stylesheet" href="importtool_peer/css/main.css"  type="text/css" />

    <style>
        @import "../../../../../../derived/ui/generated/webwidgets/web_widgets_gallery/generatedCss.css";
        #openButton,
        #closeButton {
            margin-top:20px;
            margin-bottom:20px;
            margin-left:30px;
            display:inline-block
        }
        .pageControls{
            display:block
        }

        .fileContainer{
            margin-left: 50px;
            margin-top: 25px;
            width: 500px;
            height:500px;
            position: relative;
        }

        #warningFile{
            border:none;
        }
        #warningFile.hide {
            display:none;
        }
        #warningFile.show {
            display:inline;
            color:red;
            width: 300px;
        }
        #example_ui {
            margin-left: 50px;
            margin-top: 25px;
            width: 800px;
            height: 500px;
            overflow: visible !important;
        }
        .mwSpinner {
            width: 80px;
        }
        .mwTextField {
            width: 80px;
        }
        .toolstrip .columnContainer .column {
            text-align: -webkit-right;
        }
        .mwToolstripVisualFamily.mwPushButton.mwHorizontalOrientation .mwIconNode.confirm_24 {
            height: 24px;
            width: 24px;
        }
        .mwToolstripVisualFamily.mwPushButton.mwHorizontalOrientation {
            height: 28px;
        }

    </style>
</head>
<body class="tundra">

<!-- Load dojo -->
<script src="/derived/ui/generated/datatools/importtool_js_peer/importtool_peer/generatedDojoConfig.js"></script>
<script type="text/javascript" src="../../../../../../../derived/3p/ui/dojo/dojo.js"></script>



<div class="pageControls">
    <input type="button" id="openButton" value="Launch Import Tool" onclick="launchImportTool();" style="margin-left:5px;"/>
    <input type="button" id="closeButton" value="Close Import Tool" onclick="closeVariable();" style="margin-left:5px;"/>
    <input type="file" id="chooseFile" value="File Picker"/>
    <input type="text" id="warningFile" class="hide"/>
    Range:<input type="text" id="Range">
    Variable Names Row:<input type="text" id="VariableNamesRow">
</div>



<script type="text/javascript">

    var ImportToolFactory = null;
    var spreadsheetWidget = null;
    var fileName = null;
    var container = null;
    var peerImportWidget = null;
    var fileChooser = document.getElementById("chooseFile");
    // Only one file will be chosen for now.
    fileChooser.addEventListener("change", function(event) {
        require([
            "dojo/dom-class"
        ], function(domClass) {
            if (event.target.files && event.target.files.length > 0) {
                fileName = event.target.files[0].name;
                var warningText = document.getElementById("warningFile");
                domClass.remove(warningText, "show");
                domClass.add(warningText, "hide");
            } else {
                fileName = null;
            }
        });

    });

    var closeVariable = function () {

        if (spreadsheetWidget) {
            ImportToolFactory.destroyDataSource(spreadsheetWidget);
        }

        if (container) {
            container.destroyRecursive();
            container = null;
        }

        var importToolDocument = document.getElementsByClassName("fileContainer");
        if (importToolDocument.length > 0) {
            document.body.removeChild(importToolDocument[0]);
        }

    }

    var launchImportTool = function () {
        require([
            "importtool_peer/RemoteImportFileFactory",
            "mw-messageservice/MessageService",
            "importtool_peer/RemoteImportToolManager",
            "dojo/dom-construct",
            "dojo/dom-class",
            "dojo/on",
            "MW/uiframework/UIContainer",
            "MW/uiframework/uicontainer/DocumentTypeProperties",
            "importtool_peer/PeerImportToolWidget"
        ], function(RemoteImportFileFactory, MessageService, RemoteImportToolManager, domConstruct, domClass, on, UIContainer, DocumentTypeProperties, PeerImportToolWidget) {

            if (fileName) {
                MessageService.subscribe("/ImportSelectionChanged", function (event) {
                    var rangeTextBox = document.getElementById('Range');
                    rangeTextBox.value = "rows: " + event.data.rows + "; cols:" + event.data.columns + "]";
                });

                MessageService.subscribe("/ImportSelectionChanged", function (event) {
                    var headerRowTextBox = document.getElementById('VariableNamesRow');
                    headerRowTextBox.value = event.data.headerRow;
                });

                // 3. Create wrapper document
                var fileContainer = domConstruct.toDom("<div class='fileContainer'></div>");
                var wrapper = domConstruct.toDom("<div id='example_ui'></div>");
                fileContainer.appendChild(wrapper);
                document.body.appendChild(fileContainer);

                // create uicontainer and add toolstrip
                if (!container) {
                    container = createUIContainer(UIContainer);
                }
                // register import document type along with toolstrip config info
                _registerImportDocumentType(container, PeerImportToolWidget, 'spreadsheet');
                // add the spreadsheet node to container
                _addDocumentToContainer(container, PeerImportToolWidget, fileName);

                var table = fileContainer.getElementsByClassName('SpreadsheetImportWidget')[0];
                spreadsheetWidget = dijit.getEnclosingWidget(table);

/*                 on.emit(spreadsheetWidget.domNode, "startup", {
                    bubbles: false,
                    cancelable: true
                });*/

                container.startup();
            }
            else {
                 var warningText = document.getElementById("warningFile");
                domClass.add(warningText, "show");
                warningText.value = "Please Select a file from MATLAB Root";
            }
        });
    };

    function createUIContainer(UIContainer) {
        // Create UI Container
        return new UIContainer("example_ui", {
            title: "Spreadsheet Import Debug Page",
            hasMnemonics: true,
            reserveDocumentSpace: true
        });
    }

    function _registerImportDocumentType(container, PeerImportToolWidget, type) {
        peerImportWidget = new PeerImportToolWidget();
        peerImportWidget.registerImportDocumentType(container, type);
    }

    function _addDocumentToContainer(container, PeerImportToolWidget, dataSource) {
       var importtool = peerImportWidget.openNewDataSource(container, dataSource, 'spreadsheet');
    }


</script>
</body>
</html>
