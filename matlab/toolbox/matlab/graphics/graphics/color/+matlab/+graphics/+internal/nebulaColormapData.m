function h = nebulaColormapData(generateData)
% Returns 256 values of the nebula colormap

%   Copyright 2024 The MathWorks, Inc.

arguments
    generateData {mustBeNumericOrLogical} = false
end

if generateData
    h = createNebulaColomapData();
else
    h = [
        0   0.543355162680754   0.983256219586241
        0   0.541286893518695   0.982757561235080
        0   0.539209308955143   0.982229560306851
        0   0.537122332555093   0.981672125509181
        0   0.535025887015661   0.981085167754216
        0   0.532919894144581   0.980468600174583
        0   0.530804274837651   0.979822338139179
        0   0.528678949055095   0.979146299268777
        0   0.526543835796786   0.978440403451461
        0   0.524398853076273   0.977704572857877
        0   0.522243917893568   0.976938731956296
        0   0.520078946206630   0.976142807527501
        0   0.517903852901485   0.975316728679477
        0   0.515718551760927   0.974460426861918
        0   0.513522955431720   0.973573835880533
        0   0.511316975390252   0.972656891911167
        0   0.509100521906550   0.971709533513717
        0   0.506873504006581   0.970731701645849
        0   0.504635829432776   0.969723339676522
        0   0.502387404602669   0.968684393399296
        0   0.500128134565573   0.967614811045442
        0   0.497857922957201   0.966514543296843
        0   0.495576671952121   0.965383543298682
        0   0.493284282213956   0.964221766671921
        0   0.490980652843198   0.963029171525564
        0   0.488665681322537   0.961805718468703
        0   0.486339263459571   0.960551370622350
        0   0.484001293326763   0.959266093631040
        0   0.481651663198515   0.957949855674223
        0   0.479290263485211   0.956602627477422
        0   0.476916982664057   0.955224382323172
        0   0.474531707206579   0.953815096061727
        0   0.472134321502582   0.952374747121537
        0   0.469724707780397   0.950903316519501
        0   0.467302746023209   0.949400787870973
        0   0.464868313881268   0.947867147399546
        0   0.462421286579749   0.946302383946594
        0   0.459961536822031   0.944706488980571
        0   0.457488934688141   0.943079456606080
        0   0.455003347528097   0.941421283572691
        0   0.452504639849859   0.939731969283520
        0   0.449992673201586   0.938011515803563
        0   0.447467306047878   0.936259927867781
        0   0.444928393639652   0.934477212888940
        0   0.442375787877274   0.932663380965197
        0   0.439809337166572   0.930818444887443
        0   0.437228886267283   0.928942420146383
        0.022235460986730   0.434634276133492   0.927035324939367
        0.067379258122756   0.432025343745581   0.925097180176973
        0.097680354600711   0.429401921933153   0.923128009489315
        0.121378832426430   0.426763839188394   0.921127839232115
        0.141373304874423   0.424110919469251   0.919096698492496
        0.158929438599359   0.421442981991795   0.917034619094528
        0.174730844248014   0.418759841011075   0.914941635604504
        0.189194851195018   0.416061305589717   0.912817785335959
        0.202597636611040   0.413347179353464   0.910663108354417
        0.215132779624232   0.410617260232789   0.908477647481883
        0.226941945308739   0.407871340189664   0.906261448301054
        0.238132350699854   0.405109204928449   0.904014559159280
        0.248787357515242   0.402330633589847   0.901737031172237
        0.258973227533092   0.399535398426716   0.899428918227348
        0.268743610584832   0.396723264460486   0.897090276986919
        0.278142629186979   0.393893989116781   0.894721166891010
        0.287207060301920   0.391047321838774   0.892321650160034
        0.295967916843132   0.388183003676609   0.889891791797076
        0.304451618699148   0.385300766851162   0.887431659589944
        0.312680876089746   0.382400334290186   0.884941324112941
        0.320675366942887   0.379481419134763   0.882420858728358
        0.328452263952865   0.376543724213762   0.879870339587693
        0.336026650064933   0.373586941483819   0.877289845632596
        0.343411849876918   0.370610751432107   0.874679458595523
        0.350619696800392   0.367614822438904   0.872039263000119
        0.357660750527541   0.364598810096698   0.869369346161320
        0.364544475618419   0.361562356482239   0.866669798185173
        0.371279389353030   0.358505089377579   0.863940711968372
        0.377873185054321   0.355426621435796   0.861182183197510
        0.384332835662675   0.352326549286589   0.858394310348056
        0.390664681281365   0.349204452576502   0.855577194683039
        0.396874503613694   0.346059892937945   0.852730940251452
        0.402967589605168   0.342892412880571   0.849855653886371
        0.408948786137637   0.339701534597878   0.846951445202785
        0.414822547261001   0.336486758681112   0.844018426595147
        0.420592975165845   0.333247562731671   0.841056713234629
        0.426263855878084   0.329983399862206   0.838066423066099
        0.431838690480484   0.326693697075467   0.835047676804805
        0.437320722525084   0.323377853508695   0.832000597932771
        0.442712962187472   0.320035238529856   0.828925312694909
        0.448018207622310   0.316665189670352   0.825821950094836
        0.453239063905054   0.313267010376981   0.822690641890408
        0.458377959883982   0.309839967563655   0.819531522588962
        0.463437163216529   0.306383288940959   0.816344729442264
        0.468418793822602   0.302896160098679   0.813130402441175
        0.473324835953191   0.299377721313151   0.809888684310019
        0.478157149044008   0.295827064047365   0.806619720500666
        0.482917477499841   0.292243227107343   0.803323659186319
        0.487607459535229   0.288625192413040   0.800000651255013
        0.492228635180002   0.284971880335963   0.796650850302820
        0.496782453543831   0.281282144548551   0.793274412626764
        0.501270279421694   0.277554766321984   0.789871497217444
        0.505693399311678   0.273788448199176   0.786442265751362
        0.510053026907633   0.269981806958006   0.782986882582958
        0.514350308121475   0.266133365765915   0.779505514736358
        0.518586325683332   0.262241545410356   0.775998331896823
        0.522762103362045   0.258304654469704   0.772465506401903
        0.526878609843522   0.254320878265222   0.768907213232305
        0.530936762300229   0.250288266405712   0.765323630002460
        0.534937429681304   0.246204718701235   0.761714936950797
        0.538881435749521   0.242067969179264   0.758081316929728
        0.542769561888523   0.237875567883772   0.754422955395327
        0.546602549701179   0.233624860072484   0.750740040396727
        0.550381103417765   0.229312962346430   0.747032762565208
        0.554105892130691   0.224936735144476   0.743301315103006
        0.557777551870853   0.220492750907797   0.739545893771803
        0.561396687539084   0.215977257057283   0.735766696880946
        0.564963874704921   0.211386132719845   0.731963925275346
        0.568479661283674   0.206714837872810   0.728137782323094
        0.571944569101732   0.201958353228827   0.724288473902774
        0.575359095359103   0.197111108728608   0.720416208390475
        0.578723713997336   0.192166897905538   0.716521196646510
        0.582038876980249   0.187118774577626   0.712603652001828
        0.585305015494155   0.181958927225738   0.708663790244125
        0.588522541073745   0.176678524910663   0.704701829603664
        0.591691846659203   0.171267526483187   0.700717990738780
        0.594813307589629   0.165714441873090   0.696712496721084
        0.597887282537455   0.160006029973350   0.692685573020371
        0.600914114388091   0.154126911379261   0.688637447489210
        0.603894131068720   0.148059064883902   0.684568350347235
        0.606827646329803   0.141781162308750   0.680478514165126
        0.610943688809989   0.136847040262300   0.677552094623347
        0.616246793835273   0.133362244692060   0.675786000570937
        0.621510103445485   0.129782693387893   0.673995374037640
        0.626734082344146   0.126102167276577   0.672180375667611
        0.631919169185006   0.122313634682319   0.670341167848312
        0.637065778069001   0.118409098664831   0.668477914683207
        0.642174299940695   0.114379405899588   0.666590781963960
        0.647245103892318   0.110214004636141   0.664679937142115
        0.652278538382703   0.105900634217089   0.662745549300261
        0.657274932377800   0.101424921072396   0.660787789122676
        0.662234596418808   0.096769844505305   0.658806828865437
        0.667157823623454   0.091915017342964   0.656802842325996
        0.672044890625411   0.086835696974239   0.654776004812226
        0.676896058456482   0.081501392795073   0.652726493110900
        0.681711573375692   0.075873849877767   0.650654485455632
        0.686491667649164   0.069904031601262   0.648560161494248
        0.691236560284265   0.063527421942891   0.646443702255596
        0.695946457721246   0.056656348417645   0.644305290115767
        0.700621554485336   0.049166648989091   0.642145108763751
        0.705262033802008   0.040872614745265   0.639963343166480
        0.709868068177910   0.031914565725178   0.637760179533292
        0.714439819949758   0.022991937336983   0.635535805279770
        0.718977441803331   0.014116071553126   0.633290408990974
        0.723481077264502   0.005289743082932   0.631024180384036
        0.727950861164130                   0   0.628737310270130
        0.732386920078477                   0   0.626429990515790
        0.736789372746694                   0   0.624102414003567
        0.741158330466810                   0   0.621754774592024
        0.745493897471560                   0   0.619387267075053
        0.749796171285265                   0   0.617000087140496
        0.754065243062919                   0   0.614593431328063
        0.758301197912552                   0   0.612167496986546
        0.762504115201832                   0   0.609722482230287
        0.766674068849854                   0   0.607258585894920
        0.770811127604953                   0   0.604776007492345
        0.774915355309341                   0   0.602274947164937
        0.778986811151318                   0   0.599755605638965
        0.783025549905756                   0   0.597218184177215
        0.787031622163478                   0   0.594662884530781
        0.791005074550178                   0   0.592089908890032
        0.794945949935412                   0   0.589499459834718
        0.798854287632215                   0   0.586891740283201
        0.802730123587832                   0   0.584266953440793
        0.806573490566021                   0   0.581625302747182
        0.810384418321382                   0   0.578966991822919
        0.814162933766104                   0   0.576292224414948
        0.817909061129528                   0   0.573601204341150
        0.821622822110875                   0   0.570894135433888
        0.825304236025488                   0   0.568171221482513
        0.828953319944904                   0   0.565432666174809
        0.832570088831053                   0   0.562678673037360
        0.836154555664871                   0   0.559909445374789
        0.839706731569590                   0   0.557125186207856
        0.843226625928959                   0   0.554326098210377
        0.846714246500632                   0   0.551512383644921
        0.850169599524940                   0   0.548684244297268
        0.853592689829268                   0   0.545841881409576
        0.856983520928229                   0   0.542985495612219
        0.860342095119822                   0   0.540115286854268
        0.863668413577756                   0   0.537231454332554
        0.866962476440107                   0   0.534334196419283
        0.870224282894467                   0   0.531423710588149
        0.873453831259726                   0   0.528500193338890
        0.876651119064652                   0   0.525563840120254
        0.879816143123376                   0   0.522614845251293
        0.882948899607931                   0   0.519653401840948
        0.886049384117961                   0   0.516679701705858
        0.889117591747703                   0   0.513693935286327
        0.892153517150375                   0   0.510696291560383
        0.895157154600051                   0   0.507686957955855
        0.898128498051129                   0   0.504666120260401
        0.901067541195497                   0   0.501633962529397
        0.903974277517466                   0   0.498590666991612
        0.906848700346569                   0   0.495536413952577
        0.909690802908305                   0   0.492471381695557
        0.912500578372897                   0   0.489395746380018
        0.915278019902145                   0   0.486309681937503
        0.918023120694442                   0   0.483213359964789
        0.920735874028012                   0   0.480106949614215
        0.923416273302449                   0   0.476990617481063
        0.926064312078594                   0   0.473864527487844
        0.928679984116835                   0   0.470728840765373
        0.931263283413861                   0   0.467583715530462
        0.933814204237934                   0   0.464429306960094
        0.936332741162732                   0   0.461265767061890
        0.938818889099798                   0   0.458093244540720
        0.941272643329660                   0   0.454911884661237
        0.943693999531640                   0   0.451721829106160
        0.946082953812423                   0   0.448523215830078
        0.948439502733399                   0   0.445316178908551
        0.950763643336842                   0   0.442100848382268
        0.953055373170934                   0   0.438877350095992
        0.955314690313697                   0   0.435645805532039
        0.957541593395852                   0   0.432406331637960
        0.959736081622634                   0   0.429159040648147
        0.961898154794607                   0   0.425904039898995
        0.964027813327496                   0   0.422641431637282
        0.966125058271073                   0   0.419371312821360
        0.968189891327125                   0   0.416093774914747
        0.970222314866518                   0   0.412808903671687
        0.972222331945397                   0   0.409516778914178
        0.974189946320544                   0   0.406217474299967
        0.976125162463904                   0   0.402911057080957
        0.978027985576325                   0   0.399597587851425
        0.979898421600503                   0   0.396277120285414
        0.981736477233189                   0   0.392949700862611
        0.983542159936644                   0   0.389615368581953
        0.985315477949386                   0   0.386274154662167
        0.987056440296231                   0   0.382926082228375
        0.988765056797660                   0   0.379571165983809
        0.990441338078518                   0   0.376209411865629
        0.992085295576068                   0   0.372840816683736
        0.993696941547412                   0   0.369465367741383
        0.995276289076299                   0   0.366083042436276
        0.996823352079337                   0   0.362693807840770
        0.998338145311609                   0   0.359297620259597
        0.999820684371724                   0   0.355894424763469
        1.000000000000000                   0   0.352484154696735
        1.000000000000000                   0   0.349066731157073
        1.000000000000000                   0   0.345642062445074
        1.000000000000000                   0   0.342210043481315
        1.000000000000000                   0   0.338770555188311
        1.000000000000000                   0   0.335323463834509
        1.000000000000000                   0   0.331868620337159
        1.000000000000000                   0   0.328405859520621
        1.000000000000000                   0   0.324934999326321
        1.000000000000000                   0   0.321455839970147
        1.000000000000000                   0   0.317968163042676
        ];
end

end

function map = createNebulaColomapData
% Creates the color data above, using 256 colors
m = 256;

blue_lch = [54, 70, 4.6588];
l_mid = 40;
red_lch =[54, 90, 6.6378909];

mid = round(m/2);
lch = [[linspace(blue_lch(1), l_mid, mid), ...
    linspace(l_mid, red_lch(1), m-mid)]', ...    % luminance column
    [linspace(blue_lch(2), red_lch(2), m)]', ... % chroma column
    [linspace(blue_lch(3), red_lch(3), m)]'];    % hue column

lab = [lch(:, 1), lch(:, 2) .* cos(lch(:, 3)), ...
    lch(:, 2) .* sin(lch(:, 3))];

xyz = lab2xyz(lab);
map = xyz2rgb(xyz);

% Out-of-gamut clipping:
map(map<0) = 0;
map(map>1) = 1;


%Further local functions:
    function xyz = lab2xyz(lab)
        L = lab(:, 1);
        a = lab(:, 2);
        b = lab(:, 3);

        % Standard illuminant - D65
        xn = 95.047;
        yn = 100;
        zn = 108.883;

        x = xn * finv((L+16)/116 + a/500);
        y = yn * finv((L+16)/116);
        z = zn * finv((L+16)/116 - b/200);

        xyz = [x, y, z];
    end

    function out = finv(in)
        delta = 6/29;

        idx = in > delta;
        out = zeros(size(in));

        out(idx) = in(idx).^3;
        out(~idx) = 3*delta.^2*(in(~idx) - 4/29);
    end

    function rgb = xyz2rgb(xyz)
        xyzTorgbMatrix = [
            3.2406, -1.5372, -0.4986;
            -0.9689, 1.8758, 0.0415;
            0.0557, -0.2040, 1.0570];

        xyz = xyz/100;
        rgb_linear = (xyzTorgbMatrix * xyz')';
        in_sign = -2*(rgb_linear < 0) + 1;
        idx = rgb_linear <= 0.0031308;

        rgb = abs(rgb_linear);
        rgb(idx) = 12.92 * rgb(idx);
        rgb(~idx) = 1.055 * rgb(~idx).^(1/2.4) - 0.055;
        rgb = rgb .* in_sign;
    end

end